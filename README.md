# OpenSCAD Tree-Sitter Monorepo

This monorepo contains packages for parsing and working with OpenSCAD files using Tree-sitter.

## Repository Structure

This is an Nx monorepo with PNPM workspaces containing the following packages:

- **packages/tree-sitter-openscad**: Tree-sitter grammar for OpenSCAD
- **packages/openscad-parser**: TypeScript parser for OpenSCAD using the tree-sitter grammar

```
openscad-tree-sitter/
├── packages/
│   ├── tree-sitter-openscad/   # Tree-sitter grammar package
│   │   ├── bindings/           # Language bindings
│   │   │   ├── node/           # Node.js bindings
│   │   │   └── wasm/           # WebAssembly bindings
│   │   ├── examples/           # Example OpenSCAD files
│   │   ├── grammar.js          # The grammar definition
│   │   ├── queries/            # Tree-sitter queries
│   │   ├── src/                # Source code
│   │   └── test/               # Tests for the grammar
│   │
│   └── openscad-parser/        # TypeScript parser package
│       ├── src/                # Source code
│       │   └── lib/            # Library code
│       │       ├── ast/        # Abstract Syntax Tree
│       │       ├── openscad-parser/ # Parser implementation
│       │       └── test-utils/ # Testing utilities
│       └── test/               # Tests for the parser
│
├── docs/                       # Documentation
├── nx.json                     # Nx configuration
└── pnpm-workspace.yaml         # PNPM workspace configuration
```

## Key Files and Their Purposes

### Core Files

- **grammar.js**: The heart of the project, containing the grammar definition for the OpenSCAD language. This file defines all syntax rules, operator precedence, and language constructs.

- **package.json**: Project configuration, dependencies, and scripts for building, testing, and running the parser.

- **tree-sitter.json**: Configuration for tree-sitter CLI, specifying which language bindings to generate (currently only Node.js).

### Generated Files

These files are automatically generated by the build process and should not be edited manually:

- **src/parser.c**: The C implementation of the parser, generated from grammar.js.
- **src/grammar.json**: JSON representation of the grammar rules.
- **src/node-types.json**: Definitions of syntax tree node types.
- **bindings/wasm/tree-sitter-openscad.wasm**: WebAssembly binary for browser usage.

### Queries

Queries define how editors and tools interact with the parsed syntax tree:

- **queries/highlights.scm**: Rules for syntax highlighting in editors.
- **queries/folds.scm**: Rules for code folding (collapsing blocks of code).
- **queries/indents.scm**: Rules for automatic indentation.
- **queries/locals.scm**: Rules for tracking local variables and their scopes.
- **queries/tags.scm**: Rules for code navigation (jumping to definitions).

### Node.js Bindings

- **bindings/node/index.js**: JavaScript interface for using the parser in Node.js.
- **bindings/node/index.d.ts**: TypeScript type definitions.
- **bindings/node/binding.cc**: C++ code that connects the parser to Node.js.

### WebAssembly Support

- **bindings/wasm/tree-sitter-openscad.wasm**: Compiled WebAssembly module.
- **src/web/openscad-wasm.js**: JavaScript code for loading and using the WASM module.

### Tests

- **test/corpus/**: Test files that verify the grammar's correctness.
- **test/nodejs/**: Tests for the Node.js bindings.
- **test/assets/all-features-openscad.scad**: A comprehensive test file covering all OpenSCAD features.

## Installation

```bash
# Clone the repository
git clone https://github.com/user/openscad-tree-sitter.git
cd openscad-tree-sitter

# Install dependencies
pnpm install
```

## Usage with Node.js

```javascript
// Using the tree-sitter grammar
const Parser = require('@openscad/tree-sitter-openscad');

// Parse OpenSCAD code
const code = `cylinder(h=10, r=5);`;
const tree = Parser.parse(code);

// Access the parsed syntax tree
console.log(tree.rootNode.toString());

// Using the TypeScript parser
const { OpenscadParser } = require('@openscad/parser');

// Create a parser instance
const parser = new OpenscadParser();

// Initialize the parser (must be done before parsing)
await parser.init();

// Parse OpenSCAD code
const ast = parser.parseAST('cube([10, 10, 10]);');
console.log(ast);

// Clean up when done
parser.dispose();
```

## Usage with TypeScript

```typescript
// Using the tree-sitter grammar
import * as Parser from '@openscad/tree-sitter-openscad';

// Parse OpenSCAD code
const code = `cylinder(h=10, r=5);`;
const tree = Parser.parse(code);

// Access the parsed syntax tree
console.log(tree.rootNode.toString());

// Using the TypeScript parser
import { OpenscadParser } from '@openscad/parser';

// Create a parser instance
const parser = new OpenscadParser();

// Initialize the parser (must be done before parsing)
await parser.init();

// Parse OpenSCAD code
const ast = parser.parseAST('cube([10, 10, 10]);');
console.log(ast);

// Clean up when done
parser.dispose();
```

## Development

This project uses [PNPM](https://pnpm.io/) as its package manager and [Nx](https://nx.dev/) for monorepo management and task running.

### Prerequisites

- Node.js (LTS version recommended)
- PNPM (Install with `npm install -g pnpm`)

### Initial Setup

1.  Clone the repository.
2.  Install dependencies:
    ```bash
    pnpm install
    ```

### Available Scripts

The following scripts are available from the root of the monorepo. These scripts typically delegate to Nx to run tasks across one or more packages.

#### Common Monorepo Commands

These commands operate on all packages within the monorepo:

-   **`pnpm build`**: Builds all packages.
    -   *When to use*: After pulling changes, before committing, or when you need a fresh build of the entire workspace.
    -   *Example*: `pnpm build`

-   **`pnpm test`**: Runs tests for all packages.
    -   *When to use*: Before committing changes, during CI, or to ensure all packages are functioning correctly.
    -   *Example*: `pnpm test`

-   **`pnpm lint`**: Lints all packages.
    -   *When to use*: To check for code style and quality issues across the entire codebase.
    -   *Example*: `pnpm lint`

-   **`pnpm lint:fix`**: Attempts to automatically fix linting issues in all packages.
    -   *When to use*: After running `pnpm lint` to automatically correct any fixable issues.
    -   *Example*: `pnpm lint:fix`

-   **`pnpm check`**: Performs type checking for all applicable packages (e.g., TypeScript packages).
    -   *When to use*: To ensure type safety across the TypeScript projects.
    -   *Example*: `pnpm check`

-   **`pnpm dev`**: Runs all packages in development/watch mode.
    -   *When to use*: When actively developing multiple packages simultaneously and you want them to rebuild on changes.
    -   *Example*: `pnpm dev`

-   **`pnpm test:watch`**: Runs tests in watch mode for all packages, re-running tests when files change.
    -   *When to use*: During active development and TDD to get immediate feedback on test results.
    -   *Example*: `pnpm test:watch`

-   **`pnpm test:coverage`**: Generates test coverage reports for all packages.
    -   *When to use*: To assess the extent of test coverage and identify untested code paths.
    -   *Example*: `pnpm test:coverage`

#### Package-Specific Commands

These commands target individual packages. Replace `<package-name>` with the actual package name (e.g., `tree-sitter-openscad`, `openscad-parser`, `openscad-editor`, `openscad-demo`).

**Build:**

-   **`pnpm build:grammar`**: Builds the `tree-sitter-openscad` grammar package.
-   **`pnpm build:parser`**: Builds the `openscad-parser` TypeScript package.
-   **`pnpm build:editor`**: Builds the `openscad-editor` React component package.
-   **`pnpm build:demo`**: Builds the `openscad-demo` application.
    -   *When to use*: When you only need to build a specific package.
    -   *Example*: `pnpm build:parser`

**Test:**

-   **`pnpm test:grammar`**: Tests `tree-sitter-openscad`.
-   **`pnpm test:parser`**: Tests `openscad-parser`.
-   **`pnpm test:editor`**: Tests `openscad-editor`.
-   **`pnpm test:demo`**: Tests `openscad-demo`.
    -   *When to use*: When you want to run tests for a single package.
    -   *Example*: `pnpm test:editor`

**Test Specific File or Pattern (for Vitest-based packages):**

For packages using Vitest (`openscad-parser`, `openscad-editor`, `openscad-demo`), you can test specific files or patterns.

-   **`pnpm test:parser:file --testFile <path/to/file.test.ts>`**: Tests a specific file in `openscad-parser`.
-   **`pnpm test:editor:file --testFile <path/to/file.test.ts>`**: Tests a specific file in `openscad-editor`.
-   **`pnpm test:demo:file --testFile <path/to/file.test.ts>`**: Tests a specific file in `openscad-demo`.
    -   *Important*: The `<path/to/file.test.ts>` should be relative to the root of the *specific package*.
    -   *When to use*: When focusing on a particular module or test suite within a package.
    -   *Example (single file)*: `pnpm test:parser:file --testFile src/lib/some-module.test.ts`
    -   *Example (testing all files in a directory)*: `pnpm test:parser:file --testFile src/lib/ast-nodes/`
    -   *Example (testing files matching a pattern)*: `pnpm test:parser:file --testFile "**/my-feature.*.test.ts"`

**Lint:**

-   **`pnpm lint:grammar`**: Lints `tree-sitter-openscad`.
-   **`pnpm lint:parser`**: Lints `openscad-parser`.
-   **`pnpm lint:editor`**: Lints `openscad-editor`.
-   **`pnpm lint:demo`**: Lints `openscad-demo`.
    -   *When to use*: To check code style for a specific package.
    -   *Example*: `pnpm lint:parser`

**Development/Watch Mode:**

-   **`pnpm dev:parser`**: Runs `openscad-parser` in development/watch mode.
-   **`pnpm dev:editor`**: Runs `openscad-editor` in development/watch mode.
-   **`pnpm dev:demo`**: Runs `openscad-demo` in development/watch mode (starts the demo app).
    -   *When to use*: When actively developing a specific package and want it to rebuild/rerun on changes.
    -   *Example*: `pnpm dev:demo`

**Type Check:**

-   **`pnpm check:parser`**: Performs type checking for `openscad-parser`.
    -   *When to use*: To ensure type safety in a specific TypeScript package.
    -   *Example*: `pnpm check:parser`

#### Utility Commands

-   **`pnpm serve:demo`**: Builds and serves the `openscad-demo` application.
    -   *When to use*: To view the live demo application in a browser.
    -   *Example*: `pnpm serve:demo`

-   **`pnpm graph`**: Opens a web interface to view the project's dependency graph using Nx.
    -   *When to use*: To understand the relationships and dependencies between packages.
    -   *Example*: `pnpm graph`

-   **`pnpm clean`**: Removes all `node_modules` directories and build artifacts (`dist` folders) from the monorepo.
    -   *When to use*: To perform a clean build or resolve caching issues.
    -   *Example*: `pnpm clean`

-   **`pnpm reset`**: Runs `pnpm clean` and then reinstalls all dependencies using `pnpm install`.
    -   *When to use*: For a complete reset of the development environment.
    -   *Example*: `pnpm reset`

-   **`pnpm parse`**: (Specific to `tree-sitter-openscad`) Likely used for debugging the grammar by parsing a file.
-   **`pnpm playground`**: (Specific to `tree-sitter-openscad`) Likely used for launching a Tree-sitter playground for the grammar.

### Building Packages

-   To build all packages: `pnpm build`
-   To build a specific package (e.g., `openscad-parser`): `pnpm build:parser` or `nx build openscad-parser`

### Running Tests

-   To run all tests: `pnpm test`
-   To run tests for a specific package (e.g., `openscad-parser`): `pnpm test:parser` or `nx test openscad-parser`
-   To run tests for a specific file within a package (e.g., `ast-utils.test.ts` in `openscad-parser`):
    `pnpm test:parser:file --testFile src/lib/ast-utils.test.ts`
-   To run tests in watch mode: `pnpm test:watch`

### Linting

-   To lint all packages: `pnpm lint`
-   To lint a specific package: `pnpm lint:parser` or `nx lint openscad-parser`
-   To automatically fix lint issues: `pnpm lint:fix`

### Development Mode

-   To run a package in development/watch mode (e.g., `openscad-demo`):
    `pnpm dev:demo` or `nx dev openscad-demo`

### Viewing Dependency Graph

Nx provides a way to visualize the project's dependency graph:

```bash
pnpm graph
```

This will open a web interface showing how the packages are interconnected.

### Known Issues and Workarounds

- **WebAssembly Build**: If you encounter issues with the WebAssembly build, ensure Docker is running and properly configured.
- **Node.js Bindings**: If you have issues with the Node.js bindings, ensure Python is installed and available in your PATH.
- **Dependency Issues**: If you encounter dependency issues, try running `pnpm install --force` to force reinstallation of dependencies.

### Build Process Explained

The build process consists of several steps:

1. **Tree-Sitter Grammar Package**:
   - `pnpm nx build tree-sitter-openscad` builds the tree-sitter grammar
   - Processes `grammar.js` to create the parser implementation
   - Generates parser code and WebAssembly bindings

2. **OpenSCAD Parser Package**:
   - `pnpm nx build openscad-parser` builds the TypeScript parser
   - Compiles TypeScript code to JavaScript
   - Generates type definitions

### Development Workflow

1. **Edit Grammar**: Modify `packages/tree-sitter-openscad/grammar.js` to update language rules
2. **Build Grammar**: Run `pnpm build:grammar` to generate updated parser code
3. **Edit Parser**: Modify files in `packages/openscad-parser/src/lib` to update the parser
4. **Build Parser**: Run `pnpm build:parser` to compile the parser
5. **Test**: Run `pnpm test` to verify changes
6. **Parse Examples**: Run `pnpm parse examples/*.scad` to test with examples
7. **Playground**: Run `pnpm playground` to interactively test the grammar

### Task Dependencies

The project is configured with task dependencies to ensure that dependent tasks are run in the correct order:

- When running `build` on the parser, it will automatically build any dependencies first
- When running `test` on any project, it will automatically build that project first
- When running `dev` on any project, it will automatically build its dependencies first

This ensures that you always have the latest code built before running tests or development tasks.

### Debugging the Grammar

When encountering parsing issues:

1. Use `pnpm parse <file.scad>` to see how a specific file is parsed
2. Check the parse tree for unexpected structures
3. Run `pnpm test:grammar` to verify grammar functionality
4. Use `pnpm playground` for interactive debugging

### Project Graph Visualization

Nx provides a visualization of the project dependency graph, which can be helpful for understanding the relationships between packages:

```bash
pnpm graph
```

This will open a browser window with an interactive visualization of the project graph, showing dependencies between packages and tasks.

## Testing

The project includes comprehensive tests to ensure both the grammar and parser correctly handle OpenSCAD code.

### Test Organization

- **packages/tree-sitter-openscad/test/corpus/**: Contains test files that validate specific grammar features
- **packages/tree-sitter-openscad/test/nodejs/**: Contains tests for the Node.js bindings
- **packages/openscad-parser/src/lib/**/*.test.ts**: Contains tests for the TypeScript parser

### Available Test Commands

```bash
# Run all tests
pnpm test

# Run tests for specific packages
pnpm test:grammar  # Test the grammar
pnpm test:parser   # Test the parser

# Run tests with coverage
pnpm test:coverage

# Run tests in watch mode
pnpm test:watch
```

### What the Tests Verify

The test suite checks various aspects of the grammar and parser, including:

- **Basic Syntax**: Comments, variable assignments, modules, functions
- **Control Structures**: If statements, for loops, conditionals
- **Expressions**: Mathematical operations, function calls, array access
- **Advanced Features**: List comprehensions, special variables, object literals
- **Edge Cases**: Error recovery, ambiguous syntax, precedence rules
- **AST Generation**: Correct conversion from CST to AST
- **Parser Features**: Error handling, initialization, cleanup

### Adding New Tests

To add new tests:

1. For grammar corpus tests, add a new section to an existing file in `packages/tree-sitter-openscad/test/corpus/` or create a new file
2. For parser tests, add test files to `packages/openscad-parser/src/lib/` alongside the code being tested
3. For real-world examples, add OpenSCAD files to `packages/tree-sitter-openscad/examples/real-world/`

## Improved Grammar Features

This grammar supports the full OpenSCAD language specification with additional improvements:

### Core Features
- Module definitions and instantiations
- Function definitions and calls
- Mathematical expressions
- Conditional statements
- For loops
- Include/use directives
- Variables and assignments

### Advanced Features
- List comprehensions with conditions
- Special variables ($fa, $fs, $fn, etc.)
- Multi-dimensional arrays
- Array slicing with range expressions
- Object literals for structured data
- Let expressions for local variable definitions
- Member access expressions
- Improved type handling (numbers, strings, booleans, undef)

## Grammar Design

### Parser Architecture

The OpenSCAD grammar is designed as an LR(1) grammar with careful attention to operator precedence and ambiguity resolution. Key design principles include:

- **Precedence Hierarchy**: Expressions follow a clear precedence order from conditional expressions (lowest) to unary expressions (highest)
- **Error Recovery**: The grammar includes robust error recovery mechanisms to handle common syntax errors
- **Conflict Resolution**: Ambiguities are resolved using precedence annotations and the conflicts array

### Handling Ambiguities

The grammar resolves several types of ambiguities:

- **Shift/Reduce Conflicts**: Resolved using precedence annotations (`prec`, `prec.left`, `prec.right`)
- **Reduce/Reduce Conflicts**: Handled through the `conflicts` array for intentional ambiguities
- **Expression vs. Statement**: Carefully separated to avoid confusion between expressions and statements

### Precedence Levels

The grammar uses the following precedence levels (higher number = higher precedence):

1. Conditional expressions (`?:`)
2. Logical OR (`||`)
3. Logical AND (`&&`)
4. Equality operators (`==`, `!=`)
5. Relational operators (`<`, `<=`, `>`, `>=`)
6. Additive operators (`+`, `-`)
7. Multiplicative operators (`*`, `/`, `%`)
8. Exponentiation (`^`)
9. Unary operators (`!`, `-`)
10. Modifiers (`#`, `!`, `%`, `*`)

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

### Contribution Guidelines

- Follow the existing code style and organization
- Add tests for new features or bug fixes
- Update documentation to reflect changes
- Ensure all tests pass before submitting a PR
- Keep PRs focused on a single change to simplify review

### Monorepo Contribution Workflow

When contributing to this monorepo, follow these steps:

1. **Identify the package**: Determine which package your change affects (tree-sitter-openscad or openscad-parser)
2. **Make changes**: Make your changes to the appropriate package
3. **Add tests**: Add tests for your changes in the same package
4. **Build and test**: Run `pnpm build:<package>` and `pnpm test:<package>` to verify your changes
5. **Check dependencies**: The task dependencies will ensure that all necessary dependencies are built
6. **Submit PR**: Submit a pull request with your changes

### Visualizing Your Changes

Before submitting a PR, it's helpful to visualize the project graph to understand how your changes affect the project:

```bash
pnpm graph
```

This will open a browser window with an interactive visualization of the project graph, showing dependencies between packages and tasks.

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- Tree-sitter team for the amazing parser generator
- OpenSCAD developers for the language specification
- Contributors who have helped improve the grammar