<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSCAD Parser Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            overflow: auto;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
            height: 400px;
            margin: 0;
        }
        .row {
            display: flex;
            gap: 20px;
        }
        .col {
            flex: 1;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .hidden {
            display: none;
        }
    </style>
    <!-- Load the web-tree-sitter library -->
    <script src="./tree-sitter.js"></script>
</head>
<body>
    <h1>OpenSCAD Parser Test</h1>
    <p>This page parses a sample OpenSCAD code using the Tree-sitter WebAssembly parser.</p>
    
    <div id="statusMessage" class="status hidden"></div>
    
    <button id="parseButton">Parse OpenSCAD Code</button>
    
    <div class="row">
        <div class="col">
            <h2>Sample Code</h2>
            <pre id="sampleContent">// OpenSCAD Sample Code
x = 10;
y = 20;
z = 30;

// Basic module
module cube_wrapper(size = 10) {
    cube(size, center = true);
}

// Function definition
function add(a, b) = a + b;

// Using the module
translate([10, 0, 0]) {
    cube_wrapper(5);
}

// Conditional
result = (x > 5) ? "Greater" : "Less";

// Mathematical operations
sum = x + y;
product = x * y;

// Vector
vector = [1, 2, 3];

// For loop (implemented as a module call in OpenSCAD)
for(i = [0:5]) {
    translate([i*10, 0, 0]) {
        sphere(r=2);
    }
}</pre>
        </div>
        <div class="col">
            <h2>Parse Result</h2>
            <pre id="parseResult">Parse result will appear here...</pre>
        </div>
    </div>
    
    <script>
        // Initialize the Tree-sitter library
        (async function initTreeSitter() {
            try {
                await TreeSitter.init();
                console.log('Tree-sitter initialized successfully');
                
                // Make TreeSitter globally available
                window.TreeSitter = TreeSitter;
            } catch (error) {
                console.error('Failed to initialize Tree-sitter:', error);
            }
        })();
    </script>
    
    <script type="module">
        import { OpenSCADParser } from './openscad-parser.js';
        
        // Element references
        const statusMessage = document.getElementById('statusMessage');
        const parseButton = document.getElementById('parseButton');
        const sampleContent = document.getElementById('sampleContent');
        const parseResult = document.getElementById('parseResult');
        
        // Show status message
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'success', 'error');
            statusMessage.classList.add(isError ? 'error' : 'success');
        }
        
        // Parse the sample content
        async function parseSample() {
            try {
                const content = sampleContent.textContent;
                
                // Initialize the parser
                const parser = new OpenSCADParser();
                showStatus('Initializing parser...');
                
                const success = await parser.initialize();
                
                if (!success) {
                    throw new Error(parser.error?.message || 'Unknown initialization error');
                }
                
                showStatus('Parser initialized successfully, parsing code...');
                
                // Parse the content
                const tree = parser.parse(content);
                
                if (!tree) {
                    throw new Error('Failed to parse content');
                }
                
                // Format and display the result
                const formattedTree = formatTree(tree.rootNode);
                parseResult.textContent = formattedTree;
                
                showStatus('Successfully parsed OpenSCAD code!');
                
                // Cleanup
                tree.delete();
            } catch (error) {
                showStatus(`Error parsing code: ${error.message}`, true);
                console.error('Error parsing sample:', error);
            }
        }
        
        // Format the parse tree for display
        function formatTree(node, indent = 0) {
            const indentStr = ' '.repeat(indent * 2);
            let result = `${indentStr}(${node.type} [${node.startPosition.row},${node.startPosition.column}] - [${node.endPosition.row},${node.endPosition.column}]`;
            
            if (node.childCount > 0) {
                result += '\n';
                for (let i = 0; i < Math.min(node.childCount, 50); i++) {
                    const child = node.child(i);
                    const fieldName = node.fieldNameForChild(i);
                    
                    if (fieldName) {
                        result += `${indentStr}  ${fieldName}: `;
                    }
                    
                    result += formatTree(child, indent + 1);
                    result += '\n';
                }
                
                if (node.childCount > 50) {
                    result += `${indentStr}  ... (${node.childCount - 50} more children)\n`;
                }
                
                result += `${indentStr})`;
            } else {
                const text = node.text.substring(0, 20).replace(/\n/g, '\\n');
                if (text) {
                    result += ` "${text}${node.text.length > 20 ? '...' : ''}")`;
                } else {
                    result += ')';
                }
            }
            
            return result;
        }
        
        // Initialize the page
        function init() {
            parseButton.addEventListener('click', () => {
                parseResult.textContent = 'Parsing...';
                // Use setTimeout to allow the UI to update
                setTimeout(() => {
                    parseSample();
                }, 10);
            });
        }
        
        // Run initialization
        init();
    </script>
</body>
</html> 