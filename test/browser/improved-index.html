<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSCAD Tree-sitter WebAssembly Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow: auto;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .code-editor {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', Courier, monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .examples {
            margin-bottom: 20px;
        }
        
        .example-button {
            background-color: #2196F3;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .output {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .loading {
            color: #2196F3;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #f44336;
        }
        
        .status-bar {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-loading {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .tree-node {
            margin-left: 20px;
        }
        
        .tree-node-name {
            font-weight: bold;
        }
        
        .tree-node-value {
            color: #2196F3;
        }
        
        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }
        
        .version-info {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>OpenSCAD Tree-sitter WebAssembly Test</h1>
    
    <p>This page tests the OpenSCAD Tree-sitter grammar using WebAssembly in the browser.</p>
    
    <div id="status-bar" class="status-bar status-loading">
        Initializing parser...
    </div>
    
    <h2>Examples</h2>
    <div class="examples">
        <button class="example-button" data-example="basic">Basic Example</button>
        <button class="example-button" data-example="modules">Modules & Functions</button>
        <button class="example-button" data-example="control">Control Structures</button>
        <button class="example-button" data-example="transformations">Transformations</button>
        <button class="example-button" data-example="csg">CSG Operations</button>
        <button class="example-button" data-example="special">Special Variables</button>
        <button class="example-button" data-example="complex">Complex Example</button>
    </div>
    
    <h2>OpenSCAD Code</h2>
    <textarea id="code-editor" class="code-editor">// Enter OpenSCAD code here
module test() {
  cube(10);
}

test();</textarea>
    
    <div class="controls">
        <button id="parse-button" disabled>Parse Code</button>
        <button id="clear-button">Clear</button>
        <button id="retry-button" style="display: none;">Retry Loading Parser</button>
    </div>

    
    <h2>Parse Tree</h2>
    <div id="output" class="output">
        <p class="loading">Parser not loaded yet. Please wait...</p>
    </div>
    
    <div class="version-info">
        <p>Using web-tree-sitter version: <span id="tree-sitter-version">Unknown</span></p>
    </div>
    
    <script type="module">
        import * as TreeSitter from 'https://cdn.jsdelivr.net/npm/web-tree-sitter@0.22.4/tree-sitter.js';
        
        // Display the version
        document.getElementById('tree-sitter-version').textContent = '0.22.4';
        
        const Parser = TreeSitter.Parser;
        
        // Examples
        const examples = {
            basic: `// Basic OpenSCAD example
cube(10);
sphere(5);
cylinder(h=10, r=5);`,
            
            modules: `// Modules and functions
module rounded_cube(size, radius) {
    hull() {
        for (x = [radius, size[0] - radius]) {
            for (y = [radius, size[1] - radius]) {
                for (z = [radius, size[2] - radius]) {
                    translate([x, y, z]) sphere(r = radius);
                }
            }
        }
    }
}

function pythagoras(a, b) = sqrt(a*a + b*b);

rounded_cube([20, 15, 10], 2);
echo(pythagoras(3, 4)); // Outputs 5`,
            
            control: `// Control structures
// If-else statement
if (true) {
    cube(10);
} else {
    sphere(5);
}

// For loop
for (i = [0:5]) {
    translate([i * 10, 0, 0])
        cube(5);
}

// Conditional operator (ternary)
size = true ? 10 : 5;
cube(size);`,
            
            transformations: `// Transformations
translate([10, 0, 0])
    rotate([0, 45, 0])
        scale([1, 2, 1])
            cube(10);

mirror([1, 0, 0])
    cylinder(h=10, r=5);

multmatrix(m = [
    [1, 0, 0, 0],
    [0, 1, 0, 0],
    [0, 0, 1, 0],
    [0, 0, 0, 1]
]) cube(10);`,
            
            csg: `// CSG operations
difference() {
    cube(20, center = true);
    sphere(15);
}

union() {
    cube(10, center = true);
    translate([10, 0, 0])
        sphere(7);
}

intersection() {
    cube(20, center = true);
    sphere(15);
}`,
            
            special: `// Special variables
$fn = 100;
cylinder(h=10, r=5);

echo($t); // Animation variable

// Preview vs render mode
if ($preview) {
    color("red") sphere(5);
} else {
    sphere(5);
}`,
            
            complex: `// Complex example
module gear(num_teeth, thickness, hole_diameter) {
    difference() {
        union() {
            cylinder(h = thickness, r = num_teeth * 2, $fn = num_teeth * 2);
            
            for (i = [0:num_teeth-1]) {
                rotate([0, 0, i * 360 / num_teeth])
                    translate([num_teeth * 2, 0, thickness / 2])
                        cube([2, 1, thickness], center = true);
            }
        }
        
        // Center hole
        cylinder(h = thickness * 2, r = hole_diameter / 2, center = true, $fn = 30);
    }
}

// Create a gear system
module gear_system() {
    gear(20, 5, 5);
    
    translate([45, 0, 0])
        gear(15, 5, 5);
    
    translate([0, 45, 0])
        gear(15, 5, 5);
}

gear_system();`
        };
        
        // Initialize variables
        let parser = null;
        let language = null;
        const codeEditor = document.getElementById('code-editor');
        const parseButton = document.getElementById('parse-button');
        const clearButton = document.getElementById('clear-button');
        const retryButton = document.getElementById('retry-button');
        const output = document.getElementById('output');
        const statusBar = document.getElementById('status-bar');
        const exampleButtons = document.querySelectorAll('.example-button');
        
        // Update status bar
        function updateStatus(type, message) {
            statusBar.className = `status-bar status-${type}`;
            statusBar.textContent = message;
        }
        
        // Initialize the parser
        async function initParser() {
            updateStatus('loading', 'Initializing parser...');
            retryButton.style.display = 'none';
            
            try {
                output.innerHTML = '<p class="loading">Loading parser...</p>';
                
                // Initialize Tree-sitter
                await Parser.init();
                parser = new Parser();
                
                // Load the OpenSCAD language
                const wasmUrl = '../../tree-sitter-openscad.wasm';
                
                try {
                    // Check if the WASM file exists by making a HEAD request
                    const checkResponse = await fetch(wasmUrl, { method: 'HEAD' });
                    if (!checkResponse.ok) {
                        throw new Error(`WASM file not found (status: ${checkResponse.status})`);
                    }
                    
                    // Load the language
                    const OpenSCAD = await TreeSitter.Language.load(wasmUrl);
                    language = OpenSCAD;
                    parser.setLanguage(language);
                    
                    updateStatus('success', 'Parser loaded successfully');
                    output.innerHTML = '<p class="success">Parser loaded successfully. Enter code and click "Parse Code".</p>';
                    parseButton.disabled = false;
                    
                    // Parse the initial code
                    parseCode();
                } catch (loadError) {
                    let errorDetails = `Message: ${loadError.message}`;
                    
                    console.error(`Error loading WASM file from ${wasmUrl}:`, loadError);
                    updateStatus('error', `Error loading WASM file: ${loadError.message}`);
                    output.innerHTML = `<p class="error">Error loading WASM file from ${wasmUrl}.<br>Details: ${errorDetails.replace(/\n/g, '<br>')}.<br>Check console for full error object.</p>`;
                    parseButton.disabled = true;
                    retryButton.style.display = 'inline-block';
                }
            } catch (error) {
                updateStatus('error', `Error initializing parser: ${error.message}`);
                output.innerHTML = `<p class="error">Error initializing parser: ${error.message}</p>`;
                console.error('Error initializing parser:', error);
                retryButton.style.display = 'inline-block';
            }
        }
        
        // Format a node for display
        function formatNode(node, indent = 0) {
            const indentStr = '  '.repeat(indent);
            let result = `<div class="tree-node">`;
            
            // Node type and field
            result += `<span class="tree-node-name">${node.type}</span>`;
            
            // Children
            if (node.childCount > 0) {
                result += `<div style="margin-left: 20px;">`;
                for (let i = 0; i < node.childCount; i++) {
                    const child = node.child(i);
                    const fieldName = node.fieldNameForChild(i);
                    
                    if (fieldName) {
                        result += `<div><span class="tree-node-field">${fieldName}:</span></div>`;
                    }
                    
                    result += formatNode(child, indent + 1);
                }
                result += `</div>`;
            } else {
                // Leaf node with text
                result += ` <span class="tree-node-value">"${node.text}"</span>`;
            }
            
            result += `</div>`;
            return result;
        }
        
        // Parse the code and display the tree
        function parseCode() {
            if (!parser || !language) {
                output.innerHTML = '<p class="error">Parser not initialized yet.</p>';
                return;
            }
            
            const code = codeEditor.value;
            
            try {
                updateStatus('loading', 'Parsing code...');
                const tree = parser.parse(code);
                const rootNode = tree.rootNode;
                
                updateStatus('success', 'Parsing successful');
                output.innerHTML = '<div class="success">Parsing successful!</div>';
                output.innerHTML += formatNode(rootNode);
            } catch (error) {
                updateStatus('error', `Error parsing code: ${error.message}`);
                output.innerHTML = `<p class="error">Error parsing code: ${error.message}</p>`;
                console.error('Error parsing code:', error);
            }
        }
        
        // Load an example
        function loadExample(exampleName) {
            if (examples[exampleName]) {
                codeEditor.value = examples[exampleName];
                if (parser && language) {
                    parseCode();
                }
            }
        }
        
        // Event listeners
        parseButton.addEventListener('click', parseCode);
        
        clearButton.addEventListener('click', () => {
            codeEditor.value = '';
            output.innerHTML = '<p>Enter OpenSCAD code and click "Parse Code".</p>';
        });
        
        retryButton.addEventListener('click', initParser);
        
        exampleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const exampleName = button.getAttribute('data-example');
                loadExample(exampleName);
            });
        });
        
        // Initialize the parser when the page loads
        window.addEventListener('load', initParser);
    </script>
</body>
</html>
